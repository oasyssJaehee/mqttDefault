<!DOCTYPE html>

<html>
<head>
<title></title>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no, target-densitydpi=medium-dpi" />
<meta name="format-detection" content="telephone=no" />
<!-- <script src="https://canvasjs.com/assets/script/jquery-1.11.1.min.js"></script> -->
<!-- <script src="https://canvasjs.com/assets/script/jquery.canvasjs.min.js"></script> -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.16.9/xlsx.full.min.js"></script>

</head>
<style>
</style>
<script type="text/javascript">
    var bsCode = "<%=bsCode%>";
    var level = "<%=session.level%>"
    var mainDcode = "";
    function init(){
        $.ajax({
            url:"/mysql/room",
            data:{
                xml:"room_main_list",
                bsCode: pad(bsCode, 7),
                dcod: mainDcode,
                statu:"",
                roomSearch: "",
                party:"",
                keyStatus:""
            },success:function(res){
                console.log(res);
                var item ="";
                for(var i=0; i<res.length; i++){

                }
            }
        });
    }
    $(window).ready(function() {
        init();
        $("#upload_btn").on("click", function(){
            $("#id_file_upload").click();
        });
        $("#sync_btn").on("click", function(){
            $.ajax({
                url:"./room_sync_check",
                data:{
                    bsCode:pad(bsCode, 7)
                }, success:function(res){
                    console.log(res);
                    if(res != null){
                        var insert = res.insert;
                        var update = res.update;

                        var logRono="";
                        var logMsg="";

                        var msg = "";
                        if(insert.length > 0){
                            msg += "[추가]\n";
                            for(var i=0; i<insert.length; i++){
                                msg += insert[i].rono+",";
                                logRono += insert[i].rono+",";
                            }
                            msg = msg.slice(0, -1);
                            msg += "\n";

                            if(insert.length > 10){
                                msg = msg.substring(0,40) + "..등 "+comma(insert.length)+"개\n";
                            }
                        }
                        if(update.length > 0){
                            msg += "[변경내역]\n";
                            for(var i=0; i<update.length; i++){
                                logRono += update[i].rono+",";
                                if(update[i].diffe != ""){
                                    if(update[i].diffe == "rtype"){
                                        msg += update[i].rono +"/타입";
                                    }else if(update[i].diffe == "floor"){
                                        msg += update[i].rono +"/층";
                                    }
                                    
                                    msg += "\n";
                                }
                            }
                        }
                        logMsg = msg;
                        

                        
                        Confirm(msg+"동기화 하시겠습니까?\n기존 객실자료는 지워집니다.", function(){
                            var data = {};
                            var saveData = true;
                            var dataArray = [];
                            var ajaxCount = 1;
                            $.ajax({
                                url : "./room_remove",
                                data:{
                                    rono:logRono,
                                    msg: logMsg,
                                    bsCode:"<%=bsCode%>",
                                    userId: "<%=session.id%>"
                                }, success:function(re){
                                    $.loading.start('Loading...');
                                    if(re.res == "101"){
                                        for(var i=0; i<insert.length; i++){
                                            dataArray.push({
                                                rono : insert[i].rono,
                                                floor : insert[i].floor,
                                                rname : insert[i].rname,
                                                rtype : insert[i].rtype,
                                                status : insert[i].status
                                            });
                                        }
                                        
                                        
                                        for(var i=0; i<update.length; i++){
                                            dataArray.push({
                                                rono : update[i].rono,
                                                floor : update[i].floor,
                                                rname : update[i].rname,
                                                rtype : update[i].rtype,
                                                status : update[i].status
                                            });
                                        }
                                        for(var i=0; i<dataArray.length; i++){
                                            var rtype = dataArray[i].rtype;
                                            var rname = dataArray[i].rname;
                                            var floor = dataArray[i].floor;
                                            var rono = dataArray[i].rono;
                                            var status = dataArray[i].status;

                                            $.ajax({
                                                url:"/mysql/room",
                                                data:{
                                                    xml: "room_insert",
                                                    rtype:rtype,
                                                    floor:floor,
                                                    rname:rname,
                                                    rono:rono,
                                                    bsCode:"<%=bsCode%>",
                                                    userId: "<%=session.id%>",
                                                    status: status
                                                }, success: function(res){
                                                    ajaxCount++;
                                                    if(res.length == 0){
                                                        saveData = false;
                                                        msg = rono+"추가중 오류가 발생했습니다.";
                                                    }else{
                                                        if(ajaxCount == dataArray.length){
                                                            $.loading.end();
                                                            if(!saveData){
                                                                Alert(msg, function(){
                                                                    location.reload();
                                                                });
                                                            }else{
                                                                Alert("저장 되었습니다.", function(){
                                                                    location.reload();
                                                                });
                                                            }
                                                        }
                                                    }
                                                }
                                            });
                                        }
                                    }else{
                                        Alert("객실 저장에 실패했습니다.");
                                    }
                                    
                                }
                            });
                            
                        });
                    }
                    
                }
            })
        });
    });
    function upload(event){
        var ajaxCount = 1;
         var input = event.target;
        var reader = new FileReader();
        reader.onload = function(){
            var fdata = reader.result;
            var read_buffer = XLSX.read(fdata, {type : 'binary'});
            read_buffer.SheetNames.forEach(function(sheetName){
                var rowdata =XLSX.utils.sheet_to_json(read_buffer.Sheets[sheetName]);
                var saveData = true;
                
                Confirm("["+rowdata.length+"개] 객실을 추가 하시겠습니까?\n*기존 데이터는 초기화 됩니다.", function(){
                    // room_reset();
                    
                    $.loading.start('Loading...');
                    setTimeout(function() {
                        $.ajax({
                            url : "./room_remove",
                            data:{
                                rono:logRono,
                                msg: logMsg,
                                bsCode:"<%=bsCode%>",
                                userId: "<%=session.id%>"
                            }, success:function(re){
                                if(re.res == "101"){
                                    for(var i=0; i<rowdata.length; i++){
                                        var rtype = rowdata[i].타입;
                                        var rname = rowdata[i].타입명;
                                        var floor = rowdata[i].층;
                                        var rono = rowdata[i].객실번호;
                                        var status = rowdata[i].상태;

                                        $.ajax({
                                            url:"/mysql/room",
                                            data:{
                                                xml: "room_insert",
                                                rtype:rtype,
                                                floor:floor,
                                                rname:rname,
                                                rono:rono,
                                                bsCode:"<%=bsCode%>",
                                                userId: "<%=session.id%>",
                                                status: status
                                            }, success: function(res){
                                                ajaxCount++;
                                                if(res.length == 0){
                                                    saveData = false;
                                                    msg = rono+"추가중 오류가 발생했습니다.";
                                                }else{
                                                    if(ajaxCount == rowdata.length){
                                                        $.loading.end();
                                                        if(!saveData){
                                                            Alert(msg, function(){
                                                                location.reload();
                                                            });
                                                        }else{
                                                            Alert("저장 되었습니다.", function(){
                                                                location.reload();
                                                            });
                                                        }
                                                    }
                                                }
                                            }
                                        });
                                    }
                                }else{
                                    Alert("객실 저장에 실패했습니다.");
                                }
                            }
                        });
                        
                        
                    }, 1000);
                });
                
            });
        };
        reader.readAsBinaryString(input.files[0]);
    }
</script>
<body>
    <input style="display: none;" type="file" id="id_file_upload" onchange="upload(event)"/>
    <div class="right_contbox">
        <div class="main_cont_tbox dis_flex_row dis_flex_center dis_flex_end margin_bottom_20">
            <h2 class="main_cont_tit">객실 설정</h2>
            <div class="main_cont_btn_grp dis_flex_row dis_flex_center">
                <div class="main_cont_width main_cont_width01">
                    <button id="sync_btn" class="icon_btn_txt_left refresh">객실 동기화</button>
                </div>
                <div class="main_cont_width main_cont_width01">
                    <button id="upload_btn" class="icon_btn_txt_left excel">엑셀 업로드</button>
                </div>
                <div class="main_cont_width main_cont_width01">
                    <button class="icon_btn_txt_left download">양식 다운로드</button>
                </div>
            </div>
        </div>
        <div class="wcont_box wcont_box_style01">
            <div class="data_search_box dis_flex_row margin_bottom_16">
                <div class="data_search_grp">
                    <label class="setup_title">날짜</label>
                    <div class="inp_moving_widthbox inp_moving_widthbox01 dis_flex_row dis_flex_center">
                        <div class="inp_moving_width inp_moving_width01">
                            <div class="data_search_inpbox">
                                <input class="inp_style date" type="text">
                            </div>
                        </div>
                        <div class="inp_moving_width inp_moving_width02">
                            ~
                        </div>
                        <div class="inp_moving_width inp_moving_width02">
                            <div class="data_search_inpbox">
                                <input class="inp_style date" type="text">
                            </div>
                        </div>
                    </div>
                </div>
                <div class="data_search_grp">
                    <label class="setup_title">구분</label>
                    <div class="inp_moving_widthbox inp_moving_widthbox02">
                        <div class="inp_moving_width inp_moving_width01">
                            <div class="data_search_inpbox">
                                <select class="sel_style">
                                    <option selected>전체</option>
                                    <option>구분1</option>
                                    <option>구분2</option>
                                    <option>구분3</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="data_search_grp">
                    <label class="setup_title">상태</label>
                    <div class="inp_moving_widthbox inp_moving_widthbox03">
                        <div class="inp_moving_width inp_moving_width01">
                            <div class="data_search_inpbox">
                                <select class="sel_style">
                                    <option selected>전체</option>
                                    <option>구분1</option>
                                    <option>구분2</option>
                                    <option>구분3</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="data_search_grp">
                    <label class="setup_title">분류</label>
                    <div class="inp_moving_widthbox inp_moving_widthbox04">
                        <div class="inp_moving_width inp_moving_width01">
                            <div class="data_search_inpbox">
                                <select class="sel_style">
                                    <option selected>전체</option>
                                    <option>구분1</option>
                                    <option>구분2</option>
                                    <option>구분3</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="data_search_grp">
                    <label class="setup_title">동작</label>
                    <div class="inp_moving_widthbox inp_moving_widthbox05">
                        <div class="inp_moving_width inp_moving_width01">
                            <div class="data_search_inpbox">
                                <select class="sel_style">
                                    <option selected>전체</option>
                                    <option>구분1</option>
                                    <option>구분2</option>
                                    <option>구분3</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="data_search_grp">
                    <label class="setup_title">객실 번호</label>
                    <div class="inp_moving_widthbox inp_moving_widthbox06 dis_flex_row">
                        <div class="inp_moving_width inp_moving_width01">
                            <div class="data_search_inpbox">
                                <input class="inp_style search" type="text">
                            </div>
                        </div>
                        <div class="inp_moving_width inp_moving_width02">
                            <button class="default_btn">검색</button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="total_numbox">
                <h2 id="tot_h2"class="total_num_tit">총 3 개</h2>
            </div>
            <div class="table_over_stylebox">
                <div class="table_contbox table_header">
                    <table class="table_list">
                        <colgroup>
                            <col width="200px">
                            <col width="200px">
                            <col width="200px">
                            <col width="200px">
                            <col width="200px">
                            <col width="100%">
                            <col width="200px">
                        </colgroup>
                        <thead>
                            <tr>
                                <th class="table_list_th text_left">객실 번호</th>
                                <th class="table_list_th text_left">구분</th>
                                <th class="table_list_th text_left">분류</th>
                                <th class="table_list_th text_left">동작</th>
                                <th class="table_list_th text_left">상태</th>
                                <th class="table_list_th text_left">동작 날짜</th>
                                <th class="table_list_th text_left">지연 시간</th>
                            </tr>
                        </thead>
                    </table>
                </div>
                <div class="table_contbox table_body">
                    <table class="table_list hover_table">
                        <colgroup>
                            <col width="200px">
                            <col width="200px">
                            <col width="200px">
                            <col width="200px">
                            <col width="200px">
                            <col width="100%">
                            <col width="200px">
                        </colgroup>
                        <tbody>
                            <tr>
                                <td class="table_list_td text_left">로비</td>
                                <td class="table_list_td text_left">BLE</td>
                                <td class="table_list_td text_left">BOARD 제어</td>
                                <td class="table_list_td text_left">BOARD ON/OFF</td>
                                <td class="table_list_td text_left">
                                    <p class="table_list_td_ok">정상</p>
                                </td>
                                <td class="table_list_td text_left">2022-08-08 AM 10:05:53</td>
                                <td class="table_list_td text_left">00:00:01</td>
                            </tr>
                            <tr>
                                <td class="table_list_td text_left">로비</td>
                                <td class="table_list_td text_left">BLE</td>
                                <td class="table_list_td text_left">BOARD 제어</td>
                                <td class="table_list_td text_left">BOARD ON/OFF</td>
                                <td class="table_list_td text_left">
                                    <p class="table_list_td_no">지연</p>
                                </td>
                                <td class="table_list_td text_left">2022-08-08 AM 10:05:53</td>
                                <td class="table_list_td text_left">00:00:01</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="pagebtn_grp_box">
                <div class="pagebtn_grp dis_flex_center dis_flex_row">
                    <a class="pagebtn prev"></a>
                    <a class="pagebtn num active">1</a>
                    <a class="pagebtn num">2</a>
                    <a class="pagebtn num">3</a>
                    <a class="pagebtn num">4</a>
                    <a class="pagebtn num">5</a>
                    <a class="pagebtn next"></a>
                </div>
            </div>
        </div>
        <div id="room_main_pop" class="popup_wrap" style="display:flex;">
            <div class="popup_contbox">
                <div class="popup_header_grp">
                    <div class="popup_header dis_flex_row dis_flex_center dis_flex_end">
                        <div class="dis_flex_row dis_flex_center">
                            <div class="dis_flex_row dis_flex_center">
                                <h2 id="pop_rono" class="popup_title popup_title01">상세 내역</h2>
                            </div>
                        </div>
                        <div class="dis_flex_row dis_flex_center">
                            <a id="pop_close_btn" class="popup_close"></a>
                        </div>
                    </div>
                </div>
                <div class="popup_body">
                    <div class="pop_table_widthbox dis_flex_row">
                        <div class="pop_table_width pop_table_width01">
                            <div class="pop_cont_tbox" style="margin-bottom: 0;">
                                <div class="dis_flex_row dis_flex_center dis_flex_end margin_bottom_20">
                                    <h2 class="pop_cont_tit">추가 객실</h2>
                                    <h2 id="tot_h2" class="total_num_tit">총 3 개</h2>
                                </div>
                                <div class="pop_table_contbox">
                                    <div class="pop_table_cont_tbox">
                                        <p class="pop_table_cont_txt">201,202,203,204</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="pop_table_width pop_table_width02">
                            <div class="pop_cont_tbox" style="margin-bottom: 0;">
                                <div class="dis_flex_row dis_flex_center dis_flex_end margin_bottom_20">
                                    <h2 class="pop_cont_tit">변경 객실</h2>
                                    <h2 id="tot_h2" class="total_num_tit">총 3 개</h2>
                                </div>
                               
                                <div class="pop_table_contbox">
                                    <div class="pop_table_cont_tbox">
                                        <p class="pop_table_cont_txt">201,202,203,204</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="popup_footer">
                    <div class="popup_btn_grp dis_flex_row dis_flex_center dis_flex_right">
                        <!-- <div class="popup_btn_width popup_btn_width01">
                            <button class="popup_btn popup_btn01 popup_btn_cancel default_btn_white">취소</button>
                        </div> -->
                        <div class="popup_btn_width popup_btn_width02">
                            <button id="pop_confirm_btn" class="popup_btn popup_btn02 popup_btn_save default_btn_gray">확인</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</body>
</html>