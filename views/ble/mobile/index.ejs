<!DOCTYPE html>

<html>
<head>
<title><%=title%></title>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no, target-densitydpi=medium-dpi" />
<meta name="format-detection" content="telephone=no" />



<script src="/socket.io/socket.io.js"></script>

<script type="text/javascript" src="/js/mobile/chat.js"></script>
<script type="text/javascript" src="/js/upload/load-image.all.min.js"></script>
<script type="text/javascript" src="/js/upload/img_upload.js"></script>

<link href="/js/pieProgress/asPieProgress.css" rel="stylesheet" />
<script type="text/javascript" src="/js/pieProgress/jquery-asPieProgress.min.js"></script>

<link href="/js/image-popup/magnific-popup.css" rel="stylesheet" />
<script type="text/javascript" src="/js/image-popup/jquery.magnific-popup.js"></script>

<script type="text/javascript">
    var socket = io();
    var bleConnect = false;

	socket.on("ble", function(data){
		console.log(data);
        if(data.msg == "scanstop"){
            Alert("검색된 도어락이 없습니다.\n관리자에게 문의해 주세요.");
            $.loading.end();
        }else if(data.msg == "connect"){
            $("#connect").removeClass("disabled");
            $("#connect").addClass("on");
            Alert("도어락이 연결 되었습니다.");
            bleConnect = true;
            $.loading.end();
        }else if(data.msg == "disconnect"){
            $("#connect").removeClass("on");
            $("#connect").addClass("disabled");
            Alert("도어락 연결이 종료 되었습니다.");
            bleConnect = false;
            $.loading.end();
        }else if(data.msg == "mqttConnect"){
            clearInterval(mqttInterver);
            if(!data.state){
                $.ajax({
                    url:"/bleConnect",
                    data:{
                        topic: "oasyss32/20001/501"
                    },
                    success : function(result){
                    }
                });
            }else{
                $("#connect").removeClass("disabled");
                $("#connect").addClass("on");
                bleConnect = true;
                Alert("도어락이 연결 되었습니다.");
                $.loading.end();
            }
        }else if(data.msg == "open"){
            clearInterval(actionInterver);
            $.loading.end();
            if(data.state == "1"){
                Alert("문이 열렸습니다.");
            }
        }
        
        
	});
    var actionInterver;
    var clickInterver;
    var openClick = false;

    function clickCheck(){
        var count = 0;
        clickInterver = setInterval(function(){
            count++;
            if(count > 20){
                openClick = false;
                clearInterval(clickInterver);
                
            }
        }, 1000);
    }
    
    function actionCheck(){
        var count = 0;
        actionInterver = setInterval(function(){
            count++;
            if(count > 15){
                clearInterval(actionInterver);
                Alert("도어락 연결을 확인해 주세요.");
                $.loading.end();
            }
        }, 1000);
    }
    var mqttInterver;
    function mqttCheck(){
        var mqttCount = 0;
        mqttInterver = setInterval(function(){
            mqttCount++;
            if(mqttCount > 10){
                clearInterval(mqttInterver);
                Alert("브릿지 연결을 확인해 주세요.");
                $.loading.end();
            }
        }, 1000);
    }
	$(window).ready(function() {
        $.loading.start('도어락 연결 중입니다.');
        socket.emit("joinRoom", "2", "test", "0");
        setTimeout(function(){
            $.ajax({
                url:"/mqttCheck",
                data:{
                    topic: "oasyss32/20001/501"
                },
                success : function(result){
                    mqttCheck();
                }
            });  
        },1000);
        $("#connect").on("click", function(){
            $.loading.start('도어락 연결 중입니다.');
            $.ajax({
                url:"/mqttCheck",
                data:{
                    topic: "oasyss32/20001/501"
                },
                success : function(result){
                    mqttCheck();
                }
            });  
        });
		
		$("#openBtn").on("click", function(){
            if(!bleConnect){Alert("도어락을 연결해 주세요.");return;}
            if(openClick){Alert("잠시 뒤 시도해 주세요.");return;}
            Confirm("문을 여시겠습니까?", function(){
                $.loading.start('문을 여는 중입니다.');
                $.ajax({
                    url:"/doorOn",
                    data:{
                        topic: "oasyss32/20001/501"
                    },
                    success : function(result){
                        openClick = true;
                        actionCheck();
                        clickCheck();
                    }
                });
            });
		});
	});

</script>
</head>
<body>
	<div class="contents">
        <div class="key_wrap">
            <div class="key_grp_cont key_grp_cont01">
                <div class="key_top_tbox">
                    <h2 class="eng_tit">Click the button to open the door</h2>
                    <h2 class="kor_tit">버튼을 클릭하여 문을 열어주세요.</h2>
                </div>
            </div>
            <div class="key_grp_cont key_grp_cont02">
                <div class="body_open_key_box mb20">
                    <button class="door_open_btn dis_flex_row dis_flex_row_center" id="openBtn">
                        <span class="open_icon">
                            <img src="/static/img/mobile/door/open_lock04.png">
                        </span>
                        <em class="door_open_tit door_open_tit3">OPEN</em>
                    </button>
                </div>
            </div>
            <div class="key_grp_cont key_grp_cont03">
                <div class="mb20 cont_box dis_flex_row dis_flex_row_center dis_flex_row_end">
                    <div class="room_tbox">
                        <h2 class="room_tit">Room<em class="room_num">101</em></h2>
                    </div>
                    <div class="room_link_box">
                        <!-- 연결중일때 .on -->
                        <button class="room_link_btn disabled" id="connect">
                            <span class="room_link_icon"></span>
                            연결
                        </button>
                    </div>
                </div>
            </div>
            <div class="key_grp_cont key_grp_cont04">
                <div class="ck_data_box">
                    <p class="room_txt dis_flex_row dis_flex_row_center dis_flex_row_end"><em class="ck_state">CHECK-IN</em><em class="ck_txt">2022-08-03 PM 15:00</em></p>
                    <p class="room_txt dis_flex_row dis_flex_row_center dis_flex_row_end"><em class="ck_state">CHECK-OUT</em><em class="ck_txt">2022-08-04 AM 11:00</em></p>
                </div>
            </div> 
        </div>
        <div class="key_body">
            <div class="password_set_box">
                <a class="password_set_btn">
                    <h2 class="body_key_tit_sub">Room Password Setting</h2>
                    <h2 class="body_key_tit">객실 비밀번호 설정</h2>
                    <span class="body_key_sub_icon password_icon"></span>
                </a>
            </div>
            <div class="body_key_btn_grp">
                <div class="body_key_box body_key_box01">
                    <div class="bg_cont_box">
                        <h2 class="body_key_tit_sub">Room Control</h2>
                        <h2 class="body_key_tit">객실 제어</h2>
                        <span class="body_key_sub_icon body_key_sub_icon01"></span>
                    </div>
                </div>
                <div class="body_key_box body_key_box02">
                    <div class="bg_cont_box">
                        <h2 class="body_key_tit_sub">Smart Order</h2>
                        <h2 class="body_key_tit">스마트 오더</h2>
                        <span class="body_key_sub_icon body_key_sub_icon02"></span>
                    </div>
                </div>
            </div>
            <div class="body_key_btn_grp">
                <div class="body_key_box body_key_box01">
                    <div class="bg_cont_box">
                        <h2 class="body_key_tit_sub">Hotel News</h2>
                        <h2 class="body_key_tit">호텔 소식</h2>
                        <span class="body_key_sub_icon body_key_sub_icon03"></span>
                    </div>
                </div>
                <div class="body_key_box body_key_box02">
                    <div class="bg_cont_box">
                        <h2 class="body_key_tit_sub">Access List</h2>
                        <h2 class="body_key_tit">출입 내역</h2>
                        <span class="body_key_sub_icon body_key_sub_icon04"></span>
                    </div>
                </div>
            </div>
        </div>
        <div class="popup_wrap">
            <div class="popup_box popup_box_ver02">
                <div class="popup_tbox">
                    <h2 class="popup_tit dis_flex_row dis_flex_row_center"><span class="warning_icon"></span>사용 안내</h2>
                    <p class="popup_txt">스마트폰키를 사용하기 전 유의사항을 꼭 숙지하신 후 사용하세요.</p>
                    <div class="popup_info_box">
                        <div class="popup_info_tbox popup_info_tbox01">
                            <span class="popup_info_state">1</span>
                            <h2 class="popup_info_tit">스마트폰키 보호를 위해 비밀번호 노출을 최대한 삼가해 주세요.</h2>
                        </div>
                        <div class="popup_info_tbox popup_info_tbox02">
                            <span class="popup_info_state">2</span>
                            <h2 class="popup_info_tit">해당 비밀번호나 스마트폰키가 무단으로 사용되고 있는 경우 즉시 비밀번호를 변경해주세요.</h2>
                        </div>
                        <div class="popup_info_tbox popup_info_tbox03">
                            <span class="popup_info_state">3</span>
                            <h2 class="popup_info_tit">해당 스마트폰키 또는 비밀번호 키로 이루어지는 활동에 대한 책임은 당사자(사용자)에게 있다는 점을 유의해주세요.</h2>
                        </div>
                    </div>
                    <div class="check_box dis_flex_row dis_flex_row_center">
                        <div class="check_box_btn">
                            <input type="checkbox" class="ck nohidden" id="text2">
                            <label class="ck_btn" for="text2"></label>
                        </div>
                        <label class="ck_tit" for="text2">동의 후 사용합니다.</label>
                    </div>
                </div>
                <ul class="popup_bottom_box">
                    <li class="popup_bottom_btnbox">
                        <a class="popup_bottom_btn popup_bottom_btn_save">확인</a>
                    </li>
                </ul>
            </div>
        </div>
	</div>
</body>
</html>