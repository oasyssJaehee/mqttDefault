<!DOCTYPE html>

<html>
<head>
<title><%=title%></title>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no, target-densitydpi=medium-dpi" />
<meta name="format-detection" content="telephone=no" />



<script src="/socket.io/socket.io.js"></script>

<script type="text/javascript" src="/js/mobile/chat.js"></script>
<script type="text/javascript" src="/js/upload/load-image.all.min.js"></script>
<script type="text/javascript" src="/js/upload/img_upload.js"></script>

<link href="/js/pieProgress/asPieProgress.css" rel="stylesheet" />
<script type="text/javascript" src="/js/pieProgress/jquery-asPieProgress.min.js"></script>

<link href="/js/image-popup/magnific-popup.css" rel="stylesheet" />
<script type="text/javascript" src="/js/image-popup/jquery.magnific-popup.js"></script>

<script type="text/javascript">
    var socket = io();
    var bleConnect = false;

	socket.on("ble", function(data){
		console.log(data);
        if(data.msg == "scanstop"){
            Alert("검색된 도어락이 없습니다.\n관리자에게 문의해 주세요.");
            $.loading.end();
        }else if(data.msg == "connect"){
            $("#connect").removeClass("disabled");
            $("#connect").addClass("on");
            Alert("도어락이 연결 되었습니다.");
            bleConnect = true;
            $.loading.end();
        }else if(data.msg == "disconnect"){
            $("#connect").removeClass("on");
            $("#connect").addClass("disabled");
            Alert("도어락 연결이 종료 되었습니다.");
            bleConnect = false;
            $.loading.end();
        }else if(data.msg == "mqttConnect"){
            clearInterval(mqttInterver);
            if(!data.state){
                $.ajax({
                    url:"/bleConnect",
                    data:{
                        topic: "oasyss32/20001/501"
                    },
                    success : function(result){
                    }
                });
            }else{
                $("#connect").removeClass("disabled");
                $("#connect").addClass("on");
                Alert("도어락이 연결 되어 있습니다.");
                $.loading.end();
            }
        }else if(data.msg == "open"){
            clearInterval(actionInterver);
            $.loading.end();
            if(data.state == "1"){
                Alert("문이 열렸습니다.");
            }
        }
        
        
	});
    var actionInterver;
    function actionCheck(){
        var count = 0;
        actionInterver = setInterval(function(){
            count++;
            if(count > 15){
                clearInterval(actionInterver);
                Alert("도어락 연결을 확인해 주세요.");
                $.loading.end();
            }
        }, 1000);
    }
    var mqttInterver;
    function mqttCheck(){
        var mqttCount = 0;
        mqttInterver = setInterval(function(){
            mqttCount++;
            if(mqttCount > 10){
                clearInterval(mqttInterver);
                Alert("브릿지 연결을 확인해 주세요.");
                $.loading.end();
            }
        }, 1000);
    }
	$(window).ready(function() {
        $.loading.start('도어락 연결 중입니다.');
        socket.emit("joinRoom", "1", "test", "0");
        setTimeout(function(){
            $.ajax({
                url:"/mqttCheck",
                data:{
                    topic: "oasyss32/20001/501"
                },
                success : function(result){
                    mqttCheck();
                }
            });  
        },1000);
        $("#connect").on("click", function(){
            $.loading.start('도어락 연결 중입니다.');
            $.ajax({
                url:"/mqttCheck",
                data:{
                    topic: "oasyss32/20001/501"
                },
                success : function(result){
                    mqttCheck();
                }
            });  
        });
		
		$("#openBtn").on("click", function(){
            if(!bleConnect){Alert("도어락을 연결해 주세요.");return;}
            Confirm("문을 여시겠습니까?", function(){
                $.loading.start('문을 여는 중입니다.');
                $.ajax({
                    url:"/doorOn",
                    data:{
                        topic: "oasyss32/20001/501"
                    },
                    success : function(result){
                        console.log(result);
                        actionCheck();
                    }
                });
            });
		});
	});

</script>
</head>
<body>
	<div class="contents">
        <div class="key_wrap">
            <div class="key_grp_cont key_grp_cont01">
                <div class="key_top_tbox">
                    <h2 class="eng_tit">Click the button to open the door</h2>
                    <h2 class="kor_tit">버튼을 클릭하여 문을 열어주세요.</h2>
                </div>
            </div>
            <div class="key_grp_cont key_grp_cont02">
                <div class="body_open_key_box mb20">
                    <button class="door_open_btn dis_flex_row dis_flex_row_center" id="openBtn">
                        <span class="open_icon">
                            <img src="/static/img/mobile/door/open_lock04.png">
                        </span>
                        <em class="door_open_tit door_open_tit3">OPEN</em>
                    </button>
                </div>
            </div>
            <div class="key_grp_cont key_grp_cont03">
                <div class="mb20 cont_box dis_flex_row dis_flex_row_center dis_flex_row_end">
                    <div class="room_tbox">
                        <h2 class="room_tit">Room<em class="room_num">101</em></h2>
                    </div>
                    <div class="room_link_box">
                        <!-- 연결중일때 .on -->
                        <button class="room_link_btn disabled" id="connect">
                            <span class="room_link_icon"></span>
                            연결
                        </button>
                    </div>
                </div>
            </div>
            <div class="key_grp_cont key_grp_cont04">
                <div class="ck_data_box">
                    <p class="room_txt dis_flex_row dis_flex_row_center dis_flex_row_end"><em class="ck_state">CHECK-IN</em><em class="ck_txt">2022-08-03 PM 15:00</em></p>
                    <p class="room_txt dis_flex_row dis_flex_row_center dis_flex_row_end"><em class="ck_state">CHECK-OUT</em><em class="ck_txt">2022-08-04 AM 11:00</em></p>
                </div>
            </div> 
        </div>
        <div class="key_body">
            <div class="body_key_btn_grp">
                <div class="body_key_box body_key_box01">
                    <div class="bg_cont_box">
                        <h2 class="body_key_tit">홈 제어</h2>
                        <span class="body_key_sub_icon body_key_sub_icon01"></span>
                    </div>
                </div>
                <div class="body_key_box body_key_box02">
                    <div class="bg_cont_box">
                        <h2 class="body_key_tit">스마트 오더</h2>
                        <span class="body_key_sub_icon body_key_sub_icon01"></span>
                    </div>
                </div>
            </div>
            <div class="body_key_btn_grp">
                <div class="body_key_box body_key_box01">
                    <div class="bg_cont_box">
                        <h2 class="body_key_tit">호텔 소식</h2>
                        <span class="body_key_sub_icon body_key_sub_icon01"></span>
                    </div>
                </div>
                <div class="body_key_box body_key_box02">
                    <div class="bg_cont_box">
                        <h2 class="body_key_tit">출입 내역</h2>
                        <span class="body_key_sub_icon body_key_sub_icon01"></span>
                    </div>
                </div>
            </div>
        </div>
	</div>
</body>
</html>